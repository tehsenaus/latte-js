#!/usr/bin/env node

var compiler = require("../lib/compiler"),
	fs = require("fs"),
	path = require('path'),
	mkdirp = require('mkdirp'),
	glob = require("glob"),
	util = require("util");

var optimist = require('optimist')
	.usage('Latte.js compiler.\nUsage: latte [options] [--] files...')
    .boolean(['c', 'v', 'd', 'version'])
    .alias('c', 'compile')
    .alias('o', 'output')
    .alias('v', 'verbose')
    .describe('c', 'Compile input files. If not specified, evaluates the files.')
    .describe('o', 'Output directory, to be used with --compile.')
    .describe('version', 'Show version')
, argv = optimist.argv;

if ( argv.version ) {
	console.log(require("../package.json").version);
	process.exit(0);
}

var files = argv._,
	inDir = process.cwd();

if ( argv.help ) {
	optimist.showHelp();
	process.exit(-1);
}

var compilerOptions = {
	outputDir: argv.o
};

if ( !files.length ) {
	if ( process.stdin.isTTY )  {
		return require('../lib/repl')();
	} else {
		return process.stdin.pipe(compiler(compilerOptions)).pipe(process.stdout);
	}
}


// Whole directory?
if ( files[0][files[0].length-1] == '/' ) {

	var compiledFiles = compiler.compileDir(files[0], argv.o, compilerOptions);
	compiledFiles.on('error', function (e) {
		console.error(e);
		process.exit(-1);
	})
	return compiledFiles.pipe(process.stdout);

} else if ( argv.c ) {

	compiler.compileFiles(files, compilerOptions)

} else {

	// Run in-process
	// Follow example of CoffeeScript:
	// http://coffeescript.org/documentation/docs/coffee-script.html#section-9
	
	process.argv = process.argv.slice(1);

	var file = files[0];
	var input = fs.readFileSync(file, 'utf8');

	if ( input.lastIndexOf('#!', 0) === 0 ) {
		input = input.slice(input.indexOf('\n'));
	}

	var output = compiler.compile(input, compilerOptions);

	var mainModule = require.main;

	mainModule.filename = fs.realpathSync(file);
	mainModule.paths = require('module')._nodeModulePaths(file);

	Object.keys(require.cache).forEach(function (k) {
		delete require.cache[k];
	});
	
	mainModule._compile(output, mainModule.filename)
}
